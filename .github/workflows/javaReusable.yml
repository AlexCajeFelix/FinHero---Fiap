name: Java Reusable Workflow

on:
  workflow_call:
    inputs:
      java-version:
        description: "Java version to use"
        type: string
        required: false
        default: "21"
      maven-version:
        description: "Maven version to use"
        type: string
        required: false
        default: "3.9.5"
      java-distribution:
        description: "Java distribution to use"
        type: string
        required: false
        default: "temurin"
      runs-on:
        description: "Runner to use"
        type: string
        required: false
        default: "ubuntu-latest"
    secrets:
      secret-key:
        description: "Optional secret key"
        required: false
        
jobs:
  build:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Read settings.yml and set config
        id: config
        run: |
          # Use defaults if settings.yml not found or values not set
          JAVA_VERSION="${{ inputs.java-version }}"
          MAVEN_VERSION="${{ inputs.maven-version }}"
          JAVA_DIST="${{ inputs.java-distribution }}"
          JACOCO_ENABLED="true"
          JACOCO_REPORT="target/site/jacoco/jacoco.xml"
          MIN_COVERAGE="0"
          
          echo "java_version=${JAVA_VERSION}" >> $GITHUB_OUTPUT
          echo "java_distribution=${JAVA_DIST}" >> $GITHUB_OUTPUT
          echo "maven_version=${MAVEN_VERSION}" >> $GITHUB_OUTPUT
          echo "jacoco_enabled=${JACOCO_ENABLED}" >> $GITHUB_OUTPUT
          echo "jacoco_report=${JACOCO_REPORT}" >> $GITHUB_OUTPUT
          echo "min_coverage=${MIN_COVERAGE}" >> $GITHUB_OUTPUT
      
      - name: Set up JDK ${{ steps.config.outputs.java_version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ steps.config.outputs.java_version }}
          distribution: ${{ steps.config.outputs.java_distribution }}
      
      - name: Set up Maven ${{ steps.config.outputs.maven_version }}
        uses: stCarolas/setup-maven@v4.5
        with:
          maven-version: ${{ steps.config.outputs.maven_version }}
      
      - name: Build with Maven
        working-directory: finhero
        run: mvn clean install -DskipTests
        
      - name: Run tests with JaCoCo
        if: steps.config.outputs.jacoco_enabled == 'true'
        working-directory: finhero
        run: mvn jacoco:prepare-agent test jacoco:report
        
      - name: Run tests without JaCoCo
        if: steps.config.outputs.jacoco_enabled != 'true'
        working-directory: finhero
        run: mvn test
      
      - name: Generate JaCoCo Report
        if: steps.config.outputs.jacoco_enabled == 'true'
        working-directory: finhero
        run: mvn jacoco:report
        continue-on-error: true
      
      - name: Check coverage threshold
        if: steps.config.outputs.jacoco_enabled == 'true'
        id: coverage_check
        working-directory: finhero
        run: |
          if [ -f target/site/jacoco/jacoco.xml ]; then
            COVERAGE=$(grep -oP 'type="INSTRUCTION" covered=\K[0-9]+' target/site/jacoco/jacoco.xml | head -1 || echo "0")
            echo "Current coverage: $COVERAGE%"
            echo "Minimum required: ${{ steps.config.outputs.min_coverage }}%"
            
            if [ "$COVERAGE" -lt "${{ steps.config.outputs.min_coverage }}" ]; then
              echo "Coverage is below minimum threshold!" 
              exit 1
            fi
          fi
      
      - name: Display test results
        if: always()
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d finhero/target/surefire-reports ]; then
            echo "### Surefire Reports" >> $GITHUB_STEP_SUMMARY
            echo "Reports location: finhero/target/surefire-reports" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.config.outputs.jacoco_enabled }}" == "true" ] && [ -f finhero/target/site/jacoco/jacoco.xml ]; then
            echo "### JaCoCo Coverage" >> $GITHUB_STEP_SUMMARY
            echo "Coverage report: finhero/target/site/jacoco/jacoco.xml" >> $GITHUB_STEP_SUMMARY
            echo "HTML report: finhero/target/site/jacoco/index.html" >> $GITHUB_STEP_SUMMARY
            echo "Minimum coverage: ${{ steps.config.outputs.min_coverage }}%" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "JaCoCo enabled: ${{ steps.config.outputs.jacoco_enabled }}" >> $GITHUB_STEP_SUMMARY
          echo "Java version: ${{ steps.config.outputs.java_version }}" >> $GITHUB_STEP_SUMMARY
          echo "Maven version: ${{ steps.config.outputs.maven_version }}" >> $GITHUB_STEP_SUMMARY

  create-pull-request:
    name: Create pull request
    runs-on: ${{ inputs.runs-on }}
    needs: build
   
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create pull request
        uses: vsoch/pull-request-action@v3
        with:
          title: "Update Java version to ${{ inputs.java-version }}"
          body: "This PR updates the Java version to ${{ inputs.java-version }}"
          token: ${{ secrets.GITHUB_TOKEN }}